<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dar de Alta Terreno - Teko Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="./terrenos.html">
                <img src="imagenes teko/logo superior teco.png" alt="Teko Logo" width="30" height="30" class="d-inline-block align-text-top"> Teko Admin
            </a>
            <div class="d-flex">
                <span class="navbar-text me-3" id="adminWelcome">Hola, Administrador</span>
                <button class="btn btn-outline-light" id="logoutBtn">Cerrar Sesión</button>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h1 class="mb-4">Formulario de Alta de Nuevo Terreno</h1>

        <form id="altaTerrenoForm" class="p-4 border rounded shadow-sm bg-white">
            
            <div class="mb-3">
                <label for="nombre" class="form-label">Nombre del Desarrollo</label>
                <input type="text" class="form-control" id="nombre" placeholder="Ej: Teko Vista Hermosa" required>
            </div>

            <div class="mb-3">
                <label for="ubicacion" class="form-label">Ubicación (Ciudad/Zona)</label>
                <input type="text" class="form-control" id="ubicacion" placeholder="Ej: Rosarito, Baja California" required>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="precio" class="form-label">Precio (MXN)</label>
                    <input type="number" class="form-control" id="precio" min="10000" step="1000" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="tamanio" class="form-label">Tamaño (m²)</label>
                    <input type="number" class="form-control" id="tamanio" min="50" step="1" required>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="latitud" class="form-label">Latitud (Coordenada)</label>
                    <input type="text" class="form-control" id="latitud" placeholder="Ej: 32.5342">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="longitud" class="form-label">Longitud (Coordenada)</label>
                    <input type="text" class="form-control" id="longitud" placeholder="Ej: -117.0425">
                </div>
            </div>
            
            <div class="mb-3">
                <label for="imagenes" class="form-label">Imágenes (URLs separadas por coma)</label>
                <textarea class="form-control" id="imagenes" rows="3" placeholder="URL1, URL2, URL3..."></textarea>
                <div class="form-text">Usa la URL completa de cada imagen (e.g. `https://picsum.photos/400/250`).</div>
            </div>

            <div class="mb-4">
                <label for="servicios" class="form-label">Servicios Incluidos</label>
                <textarea class="form-control" id="servicios" rows="2" placeholder="Ej: Agua potable, Luz CFE, Drenaje (Separar por comas)"></textarea>
                <div class="form-text">Especifica los servicios disponibles.</div>
                <label for="descripcion" class="form-label">Descripción del Terreno</label>
                <textarea class="form-control" id="descripcion" rows="4" required></textarea>
            </div>

            <button type="submit" class="btn btn-success btn-lg"><i class="bi bi-cloud-arrow-up-fill me-2"></i> Guardar Terreno</button>
            
            <div class="mt-4 alert d-none" id="statusMessage" role="alert"></div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // --- Lógica de Autenticación y Cierre de Sesión ---
    document.addEventListener('DOMContentLoaded', () => {
        const adminWelcome = document.getElementById('adminWelcome');
        const logoutBtn = document.getElementById('logoutBtn');
        const statusMessage = document.getElementById('statusMessage');
        const altaTerrenoForm = document.getElementById('altaTerrenoForm'); // Lo definimos aquí
        
        // Verificar si el administrador está logeado
        const isLoggedIn = sessionStorage.getItem('tekoAdminLoggedIn') === 'true';
        if (!isLoggedIn) {
            alert('Acceso no autorizado. Por favor, inicie sesión.');
            window.location.href = './admin_login.html';
            return;
        }

        // Mostrar nombre de usuario
        const userName = sessionStorage.getItem('tekoUserName') || 'Administrador';
        adminWelcome.textContent = `Hola, ${userName}`;

        // Manejar el cierre de sesión
        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('tekoAdminLoggedIn');
            sessionStorage.removeItem('tekoUserName');
            alert('Sesión cerrada. Redirigiendo al login.');
            window.location.href = './admin_login.html';
        });
        
        // --- Lógica del Formulario de Alta ---
        altaTerrenoForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // 1. Recolectar datos del formulario
            const nuevoTerreno = {
                id: Date.now(), // ID temporal
                nombre: document.getElementById('nombre').value,
                ubicacion: document.getElementById('ubicacion').value,
                precio: parseFloat(document.getElementById('precio').value),
                tamanio_m2: parseFloat(document.getElementById('tamanio').value),
                latitud: document.getElementById('latitud').value || null,
                longitud: document.getElementById('longitud').value || null,
                servicios: document.getElementById('servicios').value,
                descripcion: document.getElementById('descripcion').value,
                imagenes: document.getElementById('imagenes').value.split(',').map(url => url.trim()).filter(url => url !== '')
            };
            
            // Limpiar mensaje anterior
            statusMessage.classList.add('d-none');
            statusMessage.innerHTML = '';


            // 2. Realizar el envío a la API
            try {
                // Petición real al servidor backend
                const response = await fetch('http://localhost:3000/api/terrenos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nuevoTerreno) 
                });

                if (!response.ok) {
                    // Si el servidor devuelve un error (4xx, 5xx)
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }
                
                // Asumimos éxito. Si el servidor devuelve el objeto guardado:
                const terrenoGuardado = await response.json(); 

                // Mostrar mensaje de éxito
                statusMessage.classList.remove('d-none', 'alert-danger');
                statusMessage.classList.add('alert-success');
                statusMessage.innerHTML = '<strong>¡Terreno guardado!</strong> ID: ' + (terrenoGuardado.id || nuevoTerreno.id);
                
                // Limpiar el formulario
                altaTerrenoForm.reset();

            } catch (error) {
                console.error('Error al guardar el terreno:', error);
                statusMessage.classList.remove('d-none', 'alert-success');
                statusMessage.classList.add('alert-danger');
                statusMessage.innerHTML = `<strong>Error de conexión/servidor:</strong> ${error.message}. ¿Está corriendo tu backend?`;
            }
        });
    });
</script>
</body>

</html>