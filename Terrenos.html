<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuestros Terrenos - Teko</title>

    <!-- 1. ESTILOS DE BOOTSTRAP -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Iconos de Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">


    <!-- 2. ESTILOS PERSONALIZADOS DE TEKO Y TUTORIAL -->
    <style>
        /* --- ESTILOS DEL ASISTENTE FLOTANTE --- */
        #teko-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; align-items: flex-end; }
        .teko-icon-style { cursor: pointer; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); z-index: 1001; width: 80px; height: 80px; border-radius: 50%; overflow: hidden; }
        .teko-icon-style img { width: 100%; height: 100%; object-fit: cover; }
        .teko-bubble-style { position: relative; background-color: #f8f9fa; color: #212529; padding: 10px 25px 10px 15px; border-radius: 15px; margin-right: 10px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15); max-width: 200px; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .teko-bubble-style p { margin: 0; font-size: 0.9rem; }
        #close-bubble { position: absolute; top: 5px; right: 8px; font-size: 1.2rem; font-weight: bold; color: #6c757d; cursor: pointer; line-height: 1; }
        #close-bubble:hover { color: #000; }
        .teko-window-style { position: fixed; bottom: 110px; right: 20px; width: 300px; background-color: white; border-radius: 10px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2); z-index: 1000; border: 1px solid #ddd; }
        .teko-window-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background-color: #f8f9fa; border-bottom: 1px solid #ddd; border-top-left-radius: 10px; border-top-right-radius: 10px; }
        .teko-chat-body { padding: 15px; height: 250px; overflow-y: auto; background-color: #f8f9fa; }
        .teko-chat-message { padding: 8px 12px; border-radius: 15px; margin-bottom: 10px; max-width: 80%; }
        .teko-message-bot { background-color: #e9ecef; color: #000; align-self: flex-start; }
        .teko-message-user { background-color: #0d6efd; color: white; margin-left: auto; }
        .teko-chat-options { padding: 10px; border-top: 1px solid #ddd; background-color: #fff; }

        /* --- ESTILOS DEL TUTORIAL GUIADO --- */
        .teko-highlight { position: absolute; border: 3px dashed #0d6efd; border-radius: 8px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); z-index: 1050; pointer-events: none; transition: all 0.3s ease-in-out; }
        .teko-dialog { position: absolute; background-color: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); padding: 15px; display: flex; align-items: center; gap: 15px; z-index: 1051; max-width: 350px; transition: top 0.3s ease-in-out, left 0.3s ease-in-out; }
        .teko-dialog img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .teko-dialog p { margin: 0 0 10px 0; font-size: 0.95rem; color: #333; }
        .teko-dialog .dialog-buttons { display: flex; justify-content: space-between; }
        .teko-dialog.hidden { display: none; }

        /* Estilo para botones admin en tarjetas */
        .admin-buttons { margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        /* Estilos para admin en Navbar */
        .navbar-admin-section { display: flex; align-items: center; gap: 10px; }
    </style>
</head>

<body>

    <!-- ======================= MEN√ö DE NAVEGACI√ìN ======================= -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="./inicio.html">
                <img src="imagenes teko/logo superior teco.png" alt="Teko Logo" width="30" height="30" class="d-inline-block align-text-top"> Teko
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="./inicio.html">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link active" aria-current="page" href="./terrenos.html">Terrenos</a></li>
                    <li class="nav-item"><a class="nav-link" href="./contacto.html">Contacto</a></li>
                </ul>
                <div class="navbar-admin-section ms-lg-auto">
                    <a href="admin_login.html" class="nav-link text-light" id="navbarAdminLoginLink"><i class="bi bi-box-arrow-in-right me-1"></i> Iniciar sesi√≥n como Administrador</a>
                    <span class="navbar-text text-light d-none" id="navbarAdminWelcome">Hola, Admin</span>
                    <a href="alta_terreno.html" class="btn btn-sm btn-outline-primary d-none" id="navbarAdminAltaBtn"><i class="bi bi-plus-circle-fill me-1"></i> Nuevo Terreno</a>
                    <button class="btn btn-sm btn-outline-light d-none" id="navbarLogoutBtn"><i class="bi bi-box-arrow-right me-1"></i> Cerrar Sesi√≥n</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ======================= CONTENIDO PRINCIPAL ======================= -->
    <div class="container mt-5">
        <h1 class="mb-4">Terrenos Disponibles</h1>
        <div class="d-grid gap-2 col-md-6 mx-auto mb-4 text-center">
            <button class="btn btn-success btn-lg" type="button" id="btn-cerca-mi"><i class="bi bi-geo-alt-fill me-2"></i> Mostrar Terrenos Cerca de M√≠</button>
        </div>

        <!-- Filtros -->
        <div class="row mb-4 p-3 bg-light rounded border">
            <div class="col-md-8"><label for="searchInput" class="form-label">Buscar por nombre o zona</label><input type="text" id="searchInput" class="form-control" placeholder="Ej: Teko Norte o Tijuana..."></div>
            <div class="col-md-4"><label for="priceFilter" class="form-label">Filtrar por precio</label>
                <select id="priceFilter" class="form-select">
                    <option value="">Todos los precios</option>
                    <option value="200000">Menos de $200,000</option>
                    <option value="300000">Menos de $300,000</option>
                    <option value="500000">Menos de $500,000</option>
                    <option value="1000000">Menos de $1,000,000</option>
                </select>
            </div>
        </div>

        <!-- Lista Terrenos -->
        <div id="lista-terrenos-container" class="row row-cols-1 row-cols-md-3 g-4">
            <p class="text-center col-12">Cargando terrenos...</p>
        </div>
    </div>

    <!-- ======================= ASISTENTE TEKO (HTML) ======================= -->
    <div id="teko-container">
        <div id="teko-bubble" class="teko-bubble-style"><span id="close-bubble">√ó</span><p id="teko-message">¬øBuscas tu terreno ideal?</p></div>
        <div id="teko-icon" class="teko-icon-style"><img src="imagenes teko/ajolote.gif" alt="Asistente Teko"></div>
    </div>
    <div id="teko-window" class="teko-window-style d-none">
        <div class="teko-window-header"><h5>Asistente Teko</h5><button id="close-teko" type="button" class="btn-close"></button></div>
        <div id="teko-chat-body"></div>
        <div id="teko-chat-options"></div>
    </div>

    <!-- ======================= SCRIPTS ======================= -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script del Asistente (con sessionStorage) -->
    <script>
        const tekoIcon = document.getElementById('teko-icon');
        const tekoWindow = document.getElementById('teko-window');
        const closeButton = document.getElementById('close-teko');
        const chatBody = document.getElementById('teko-chat-body');
        const chatOptions = document.getElementById('teko-chat-options');
        const tekoBubble = document.getElementById('teko-bubble');
        const tekoMessage = document.getElementById('teko-message');
        const closeBubbleButton = document.getElementById('close-bubble');
        let messageIndex = 0; let bubbleInterval; let bubbleVisible = true;
        const messages = [ '¬øBuscas tu terreno ideal?', '¬°Hazme clic para ayudarte!', '¬øNuevos lotes?', '¬°Preg√∫ntame!', '¬øAgendar cita?' ];
        function cycleProactiveMessage() { if (!tekoWindow.classList.contains('d-none') || !bubbleVisible) { tekoBubble.style.opacity = '0'; return; } tekoMessage.textContent = messages[messageIndex]; tekoBubble.style.opacity = '1'; messageIndex = (messageIndex + 1) % messages.length; }
        function startBubbleInterval() { bubbleVisible = true; clearInterval(bubbleInterval); setTimeout(cycleProactiveMessage, 1500); bubbleInterval = setInterval(cycleProactiveMessage, 5000); }
        function addMessage(message, sender = 'bot') { const msgDiv = document.createElement('div'); msgDiv.className = `teko-chat-message teko-message-${sender}`; msgDiv.textContent = message; chatBody.appendChild(msgDiv); chatBody.scrollTop = chatBody.scrollHeight; }
        function showOptions(options) { chatOptions.innerHTML = ''; options.forEach(option => { const btn = document.createElement('button'); btn.className = 'btn btn-outline-primary btn-sm m-1'; btn.textContent = option.text; btn.onclick = () => handleOptionClick(option); chatOptions.appendChild(btn); }); }
        const initialOptions = [ { text: 'Ay√∫dame a buscar', action: 'help_search_budget' }, { text: '¬øGuardar favoritos?', action: 'help_favorites' }, { text: 'Dudas (FAQ)', action: 'help_faq' }, { text: 'WhatsApp', action: 'open_whatsapp' } ];
        const budgetOptions = [ { text: '$200k', action: 'set_budget', value: 200000 }, { text: '$500k', action: 'set_budget', value: 500000 }, { text: '$1M', action: 'set_budget', value: 1000000 } ];
        const zoneOptions = [ { text: 'Tijuana', action: 'set_zone', value: 'Tijuana' }, { text: 'Rosarito', action: 'set_zone', value: 'Rosarito' }, { text: 'Tecate', action: 'set_zone', value: 'Tecate' }, { text: 'Cualquiera', action: 'set_zone', value: 'Cualquiera' } ];
        const faqOptions = [ { text: "¬øQu√© son 'servicios'?", action: 'answer_faq_servicios' }, { text: '¬øProceso de compra?', action: 'answer_faq_proceso' }, { text: 'Volver', action: 'go_to_start' } ];
        let chatSearchCriteria = { precio: null, zona: null };
        function handleOptionClick(option) {
            if (option.action !== 'go_to_start') addMessage(option.text, 'user');
            setTimeout(() => {
                switch (option.action) {
                    case 'help_search_budget': addMessage('¬°Claro! ¬øPresupuesto m√°ximo?'); showOptions(budgetOptions); break;
                    case 'set_budget': chatSearchCriteria.precio = option.value; addMessage('¬°Ok! ¬øEn qu√© zona buscas?'); showOptions(zoneOptions); break;
                    case 'set_zone':
                        chatSearchCriteria.zona = option.value;
                        addMessage('¬°Perfecto! Aplicando filtros...');
                        if(typeof priceFilter !== 'undefined') priceFilter.value = chatSearchCriteria.precio || '';
                        if(typeof searchInput !== 'undefined') searchInput.value = chatSearchCriteria.zona === 'Cualquiera' ? '' : chatSearchCriteria.zona;
                        if(typeof filtrarYRenderizar === 'function') filtrarYRenderizar(); else console.warn("filtrarYRenderizar no definida");
                        setTimeout(() => { addMessage('¬øAlgo m√°s?'); showOptions(initialOptions); chatSearchCriteria = { precio: null, zona: null }; }, 1000);
                        break;
                    case 'help_favorites': addMessage('A√∫n no tenemos favoritos, ¬°pero pronto! üòâ'); setTimeout(() => showOptions(initialOptions), 1000); break;
                    case 'help_faq': addMessage('¬øSobre qu√© quieres saber?'); showOptions(faqOptions); break;
                    case 'answer_faq_servicios': addMessage("Usualmente incluye acceso a agua, luz y drenaje."); showOptions(faqOptions); break;
                    case 'answer_faq_proceso': addMessage("1. Visita, 2. Financiamiento, 3. ¬°Firma! Es f√°cil."); showOptions(faqOptions); break;
                    case 'open_whatsapp': addMessage('Abriendo WhatsApp...'); window.open('https://wa.me/5216641234567', '_blank'); break;
                    case 'go_to_start': addMessage('¬øEn qu√© m√°s te ayudo?'); showOptions(initialOptions); break;
                }
            }, 500);
        }
        function startChat() {
            tekoWindow.classList.remove('d-none'); tekoBubble.style.opacity = '0'; clearInterval(bubbleInterval); bubbleVisible = false; chatBody.innerHTML = '';
            const userName = sessionStorage.getItem('tekoUserName');
            let welcomeMessage = '¬°Hola! Viendo terrenos... ¬øTe ayudo a filtrar o tienes dudas?'; if (userName) welcomeMessage = `¬°Hola, ${userName}! Viendo terrenos... ¬øTe ayudo a filtrar o tienes dudas?`;
            addMessage(welcomeMessage); showOptions(initialOptions);
        }
        tekoIcon.addEventListener('click', startChat);
        closeButton.addEventListener('click', () => { tekoWindow.classList.add('d-none'); startBubbleInterval(); });
        closeBubbleButton.addEventListener('click', (e) => { e.stopPropagation(); bubbleVisible = false; tekoBubble.style.opacity = '0'; clearInterval(bubbleInterval); });
        startBubbleInterval();
    </script>

    <!-- Script de Geolocalizaci√≥n (con c√°lculo distancia) -->
    <script>
        const botonCercaMi = document.getElementById('btn-cerca-mi');
        function calcularDistancia(lat1, lon1, lat2, lon2) { const R = 6371; const dLat = (lat2 - lat1) * Math.PI / 180; const dLon = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); const distancia = R * c; return distancia.toFixed(1); }
        function ordenarPorCercania(posicion) {
            botonCercaMi.disabled = true; botonCercaMi.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Calculando...';
            const userLat = posicion.coords.latitude; const userLon = posicion.coords.longitude; console.log(`Ubicaci√≥n: ${userLat}, ${userLon}`);
            if (typeof todosLosTerrenos === 'undefined' || !Array.isArray(todosLosTerrenos) || todosLosTerrenos.length === 0) { console.error("'todosLosTerrenos' no disponible."); alert("Error procesando terrenos."); botonCercaMi.disabled = false; botonCercaMi.innerHTML = '<i class="bi bi-geo-alt-fill me-2"></i> Mostrar Cerca de M√≠'; return; }
            todosLosTerrenos.forEach(terreno => { if (terreno.latitud && terreno.longitud) { terreno.distanciaKm = parseFloat(calcularDistancia(userLat, userLon, parseFloat(terreno.latitud), parseFloat(terreno.longitud))); } else { terreno.distanciaKm = Infinity; } });
            todosLosTerrenos.sort((a, b) => a.distanciaKm - b.distanciaKm);
            if(typeof renderTerrains === 'function') { renderTerrains(todosLosTerrenos, true); } else { console.error("'renderTerrains' no definida."); }
            botonCercaMi.disabled = false; botonCercaMi.innerHTML = '<i class="bi bi-geo-alt-fill me-2"></i> Mostrar Cerca de M√≠';
        }
        function errorUbicacion(error) { let mensaje = 'No pudimos obtener tu ubicaci√≥n.'; if (error.code === 1) mensaje = 'Rechazaste el permiso.'; else if (error.code === 2) mensaje = 'Posici√≥n no disponible.'; else if (error.code === 3) mensaje = 'Timeout.'; console.warn("Error geo:", error.message); alert(mensaje); botonCercaMi.disabled = false; botonCercaMi.innerHTML = '<i class="bi bi-geo-alt-fill me-2"></i> Mostrar Cerca de M√≠'; }
        botonCercaMi.addEventListener('click', () => { if (typeof todosLosTerrenos === 'undefined' || !Array.isArray(todosLosTerrenos) || todosLosTerrenos.length === 0) { alert('Espera a que carguen los terrenos.'); return; } if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(ordenarPorCercania, errorUbicacion, { enableHighAccuracy: false, timeout: 10000, maximumAge: 0 }); } else { alert('Navegador no soporta geolocalizaci√≥n.'); } });
    </script>

    <!-- Script Carga/Filtro Terrenos (con botones admin y llamada al tutorial) -->
    <script>
        let todosLosTerrenos = [];
        const contenedorTerrenos = document.getElementById('lista-terrenos-container');
        const searchInput = document.getElementById('searchInput');
        const priceFilter = document.getElementById('priceFilter');
        // --- Elementos Admin en Navbar ---
        const navbarAdminLoginLink = document.getElementById('navbarAdminLoginLink');
        const navbarAdminWelcome = document.getElementById('navbarAdminWelcome');
        const navbarAdminAltaBtn = document.getElementById('navbarAdminAltaBtn');
        const navbarLogoutBtn = document.getElementById('navbarLogoutBtn');
        // --- Fin Elementos Navbar ---
        const params = new URLSearchParams(window.location.search);
        const precioURL = params.get('precio_max');
        const zonaURL = params.get('zona');
        const cercaDeMiURL = params.get('cerca');

        let isAdminLoggedIn = false; // Estado de login admin

        // --- FUNCI√ìN LOGOUT ---
        function logoutAdmin() {
            sessionStorage.removeItem('tekoAdminLoggedIn');
            sessionStorage.removeItem('tekoAdminUser');
            alert('Sesi√≥n cerrada.');
            isAdminLoggedIn = false;
            // Refrescar UI Navbar y tarjetas
             cargarTerrenosInicial(); // Vuelve a cargar para actualizar botones
             // Opcional: recarga completa: window.location.reload();
        }
        if(navbarLogoutBtn) {
            navbarLogoutBtn.addEventListener('click', logoutAdmin);
        }

        // --- FUNCI√ìN ELIMINAR ---
        async function eliminarTerreno(id, nombre) {
            if (confirm(`¬øSeguro de eliminar "${nombre}" (ID: ${id})?`)) {
                try {
                    const response = await fetch(`http://localhost:3000/api/terrenos/${id}`, { method: 'DELETE' });
                    if (!response.ok) { let errMsg = `Error ${response.status}`; try { const err = await response.json(); if(err.error) errMsg += `: ${err.error}`; } catch(e){} throw new Error(errMsg); }
                    alert(`Terreno "${nombre}" eliminado.`);
                    cargarTerrenosInicial(); // Recarga la lista
                } catch (error) { console.error('Error al eliminar:', error); alert(`Error: ${error.message}`); }
            }
        }

        // --- FUNCI√ìN RENDERIZAR (con botones admin condicionales y href corregido) ---
        function renderTerrains(terrenos, mostrarDistancia = false) {
            contenedorTerrenos.innerHTML = '';
            if (terrenos.length === 0) { contenedorTerrenos.innerHTML = '<p class="text-center col-12 h4">No encontramos terrenos.</p>'; return; }
            const formateadorMoneda = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 2, maximumFractionDigits: 2 });
            terrenos.forEach(terreno => {
                const imagenPrincipal = (terreno.imagenes && terreno.imagenes.length > 0) ? terreno.imagenes[0] : 'https://via.placeholder.com/400x250';
                let precioFormateado = 'N/D'; if (terreno.precio) { precioFormateado = formateadorMoneda.format(terreno.precio); }
                let distanciaHTML = ''; if (mostrarDistancia && terreno.distanciaKm !== Infinity && terreno.distanciaKm !== undefined) { distanciaHTML = `<p class="card-text text-success small"><i class="bi bi-geo-alt-fill"></i> Aprox. ${terreno.distanciaKm} km</p>`; } else if (mostrarDistancia) { distanciaHTML = `<p class="card-text text-muted small"><i class="bi bi-geo-alt"></i> Ubicaci√≥n N/D</p>`; }
                const areaHTML = terreno.area ? `<p class="card-text"><i class="bi bi-rulers me-1"></i> √Årea: ${terreno.area} m¬≤</p>` : '<p class="card-text text-muted small">√Årea N/D</p>';

                // --- HTML para botones de Admin (solo si isAdminLoggedIn es true) ---
                let adminButtonsHTML = '';
                if (isAdminLoggedIn) {
                    const nombreEscapado = terreno.nombre.replace(/'/g, "\\'");
                    adminButtonsHTML = `
                        <div class="admin-buttons d-flex justify-content-end gap-2">
                             <!-- ***** HREF CORREGIDO AQU√ç ***** -->
                            <a href="alta_terreno.html?id=${terreno.id}" class="btn btn-sm btn-outline-warning" title="Editar">
                                <i class="bi bi-pencil-fill"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger" title="Eliminar" onclick="eliminarTerreno(${terreno.id}, '${nombreEscapado}')">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    `;
                }
                // --- Fin HTML botones Admin ---

                const cardHTML = `
                    <div class="col">
                        <div class="card h-100">
                             <img src="${imagenPrincipal}" class="card-img-top" alt="${terreno.nombre}" style="height: 200px; object-fit: cover;" onerror="this.onerror=null;this.src='https://via.placeholder.com/400x250/DDDDDD/808080?text=Error+Img';">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${terreno.nombre}</h5>
                                <p class="card-text"><i class="bi bi-pin-map-fill me-1"></i> ${terreno.ubicacion}</p>
                                ${areaHTML}
                                ${distanciaHTML}
                                <p class="card-text"><strong>Precio:</strong> ${precioFormateado}</p>
                                <a href="./detalles.html?id=${terreno.id}" class="btn btn-primary mt-auto">Ver Detalles</a>
                                ${adminButtonsHTML} <!-- Botones Admin se a√±aden aqu√≠ -->
                            </div>
                        </div>
                    </div>
                `;
                contenedorTerrenos.innerHTML += cardHTML;
            });
        }

        // --- FUNCI√ìN FILTRAR ---
        function filtrarYRenderizar() {
            const textoBusqueda = searchInput.value.toLowerCase();
            const precioMax = priceFilter.value;
            let terrenosFiltrados = todosLosTerrenos;
            if (precioMax) { terrenosFiltrados = terrenosFiltrados.filter(t => t.precio !== null && parseFloat(t.precio) <= parseFloat(precioMax)); }
            if (textoBusqueda) { terrenosFiltrados = terrenosFiltrados.filter(t => t.nombre.toLowerCase().includes(textoBusqueda) || t.ubicacion.toLowerCase().includes(textoBusqueda)); }
            renderTerrains(terrenosFiltrados, false); // Renderiza con botones admin si aplica (isAdminLoggedIn)
        }

        // --- FUNCI√ìN CARGA INICIAL (MODIFICADA PARA NAVBAR ADMIN) ---
        async function cargarTerrenosInicial() {
             // Verificar estado de login y actualizar UI Navbar
             isAdminLoggedIn = sessionStorage.getItem('tekoAdminLoggedIn') === 'true';
             const adminUser = sessionStorage.getItem('tekoAdminUser') || 'Admin'; // Obtener nombre si se guarda

             if(navbarAdminLoginLink) navbarAdminLoginLink.classList.toggle('d-none', isAdminLoggedIn);
             if(navbarAdminWelcome) {
                 navbarAdminWelcome.textContent = `Hola, ${adminUser}`;
                 navbarAdminWelcome.classList.toggle('d-none', !isAdminLoggedIn);
             }
             if(navbarAdminAltaBtn) navbarAdminAltaBtn.classList.toggle('d-none', !isAdminLoggedIn);
             if(navbarLogoutBtn) navbarLogoutBtn.classList.toggle('d-none', !isAdminLoggedIn);


            try {
                const response = await fetch('http://localhost:3000/api/terrenos');
                if (!response.ok) throw new Error(`Error red: ${response.statusText}`);
                todosLosTerrenos = await response.json();
                if (precioURL && Array.from(priceFilter.options).some(opt => opt.value === precioURL)) { priceFilter.value = precioURL; }
                if (zonaURL && zonaURL.toLowerCase() !== 'cualquiera') { searchInput.value = zonaURL; }
                searchInput.addEventListener('input', filtrarYRenderizar);
                priceFilter.addEventListener('change', filtrarYRenderizar);
                filtrarYRenderizar(); // Primera renderizaci√≥n (ahora incluye botones admin en tarjetas si aplica)

                // ***** INICIAR TUTORIAL DESPU√âS DE CARGAR *****
                if (typeof startPageTutorial === 'function' && typeof terrenosSteps !== 'undefined') {
                    setTimeout(() => { startPageTutorial('terrenosTutorialDone_v2', terrenosSteps); }, 300);
                } else { console.warn("Tutorial no definido."); }

                if (cercaDeMiURL === 'true') {
                     const btnCerca = document.getElementById('btn-cerca-mi');
                     if (btnCerca) { setTimeout(() => { btnCerca.click(); }, 500); }
                     else { console.warn("Bot√≥n 'cerca de m√≠' no encontrado."); }
                }
            } catch (error) { console.error('Error al cargar:', error); contenedorTerrenos.innerHTML = '<p class="text-center text-danger col-12">No se pudieron cargar los terrenos. Revisa el servidor.</p>'; }
        }
        document.addEventListener('DOMContentLoaded', cargarTerrenosInicial);
    </script>

    <!-- 5. SCRIPT DEL MODO TUTORIAL (Personalizado) -->
    <script>
        // --- Funci√≥n Gen√©rica startPageTutorial ---
        const startPageTutorial = (storageKey, steps) => {
            const tutorialCompleted = sessionStorage.getItem(storageKey);
            if (tutorialCompleted || !steps || steps.length === 0) return;
            if (document.querySelector('.teko-dialog')) { console.warn("Tutorial ya iniciado."); return; }
            const dialog = document.createElement("div"); dialog.className = "teko-dialog hidden";
            const tekoImg = document.createElement("img"); tekoImg.src = "imagenes teko/ajolote.gif"; tekoImg.alt = "Teko";
            const textContainer = document.createElement("div"); const msg = document.createElement("p");
            const btnContainer = document.createElement("div"); btnContainer.className = "dialog-buttons";
            const nextBtn = document.createElement("button"); nextBtn.className = "btn btn-primary btn-sm";
            const skipBtn = document.createElement("button"); skipBtn.className = "btn btn-secondary btn-sm"; skipBtn.textContent = "Saltar";
            btnContainer.appendChild(skipBtn); btnContainer.appendChild(nextBtn);
            textContainer.appendChild(msg); textContainer.appendChild(btnContainer);
            dialog.appendChild(tekoImg); dialog.appendChild(textContainer); document.body.appendChild(dialog);
            let currentStepIndex = 0; let currentHighlight = null;
            const showStep = (index) => {
                if (currentHighlight) { currentHighlight.remove(); currentHighlight = null; }
                const step = steps[index]; if (!step) { endTutorial(); return; }
                const target = document.querySelector(step.selector);
                if (!target) { console.warn(`Tutorial: Elemento "${step.selector}" no encontrado.`); if (index > 0) setTimeout(() => showStep(index), 300); else { console.error("Error al iniciar tutorial terrenos."); endTutorial(); } return; }
                target.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
                setTimeout(() => {
                     if (!document.body.contains(target)) { console.warn("Target desaparecido"); endTutorial(); return;}
                     const oldHighlight = document.querySelector('.teko-highlight'); if(oldHighlight) oldHighlight.remove();
                    const rect = target.getBoundingClientRect();
                    const highlight = document.createElement("div"); highlight.className = "teko-highlight";
                    highlight.style.top = `${rect.top + window.scrollY - 5}px`; highlight.style.left = `${rect.left + window.scrollX - 5}px`; highlight.style.width = `${rect.width + 10}px`; highlight.style.height = `${rect.height + 10}px`;
                    document.body.appendChild(highlight); currentHighlight = highlight;
                    msg.textContent = step.message; nextBtn.textContent = index === steps.length - 1 ? "¬°Entendido!" : "Siguiente";
                    let dialogTop = rect.bottom + window.scrollY + 10; let dialogLeft = rect.left + window.scrollX;
                    if (dialogLeft + 350 > window.innerWidth) dialogLeft = window.innerWidth - 360;
                    const dialogHeight = dialog.offsetHeight || 100; if (dialogTop + dialogHeight > window.innerHeight + window.scrollY) dialogTop = rect.top + window.scrollY - dialogHeight - 10;
                    dialog.style.top = `${dialogTop}px`; dialog.style.left = `${dialogLeft}px`; dialog.classList.remove('hidden');
                }, 350);
            };
            const endTutorial = () => { const dlg = document.querySelector('.teko-dialog'); if (dlg) dlg.remove(); const hlt = document.querySelector('.teko-highlight'); if (hlt) hlt.remove(); sessionStorage.setItem(storageKey, 'true'); };
            nextBtn.addEventListener("click", () => { currentStepIndex++; showStep(currentStepIndex); }); skipBtn.addEventListener("click", endTutorial);
            showStep(0);
        };

        // --- PASOS ESPEC√çFICOS PARA terrenos.html ---
        const terrenosSteps = [
            { selector: '#lista-terrenos-container', message: 'Aqu√≠ ver√°s la lista de terrenos. ¬°√âchales un vistazo!' },
            { selector: '#searchInput', message: 'Usa esta barra para buscar por nombre o zona si ya sabes lo que quieres.' },
            { selector: '#priceFilter', message: 'O filtra por tu presupuesto m√°ximo usando este men√∫.' },
            { selector: '#btn-cerca-mi', message: '¬øQuieres ver qu√© hay cerca? Haz clic aqu√≠ y ordenar√© la lista por distancia.' },
            { selector: '#teko-icon', message: 'Y recuerda, si necesitas ayuda, ¬°aqu√≠ estoy! Solo haz clic.' },
             // Opcional: A√±adir paso para login admin si no est√° logueado
             // { selector: '#navbarAdminLoginLink', message: 'Si eres administrador, puedes iniciar sesi√≥n desde aqu√≠ para gestionar los terrenos.' }
        ];
        // La llamada a startPageTutorial se hace desde cargarTerrenosInicial
    </script>

</body>
</html>